# База данных TaskForge

## Описание

База данных для проекта TaskForge содержит таблицу платежей клиентов и табличную функцию для получения поденных сумм платежей.

## Структура базы данных

### Таблицы

- **ClientPayments** - таблица платежей клиентов
  - `Id` (bigint) - первичный ключ
  - `ClientId` (bigint) - идентификатор клиента
  - `Dt` (datetime2(0)) - дата платежа
  - `Amount` (money) - сумма платежа

### Функции

- **GetDailyPayments** - табличная функция для получения поденных сумм платежей
  - Параметры:
    - `@ClientId` (bigint) - идентификатор клиента
    - `@Sd` (date) - начальная дата интервала
    - `@Ed` (date) - конечная дата интервала
  - Возвращает:
    - `Dt` (date) - дата
    - `Сумма` (money) - сумма платежей за день (0 если платежей не было)

## Установка

### Вариант 1: Установка всех компонентов одной командой

```sql
:r install-all.sql
```

### Вариант 2: Пошаговая установка

1. Создание базы данных:
   ```sql
   :r create-database.sql
   ```

2. Создание таблицы:
   ```sql
   :r dbo/tables/ClientPayments.sql
   ```

3. Создание функции:
   ```sql
   :r dbo/functions/GetDailyPayments.sql
   ```

4. Вставка тестовых данных (опционально):
   ```sql
   :r dbo/tables/ClientPayments_SeedData.sql
   ```

## Тестирование

### Базовые тесты
Для запуска базовых тестов выполните:

```sql
:r tests/test-GetDailyPayments.sql
```

### Примеры из задания с проверкой
Для просмотра результатов выполнения примеров из задания:

```sql
:r tests/examples-GetDailyPayments.sql
```

### Проверка ожидаемых результатов
Для сравнения фактических результатов с ожидаемыми:

```sql
:r tests/expected-results.sql
```

### Автоматическая верификация
Для автоматической проверки всех требований задания:

```sql
:r tests/verify-results.sql
```

### Фактические результаты
Для просмотра фактических результатов выполнения функции:

```sql
:r tests/actual-results.sql
```

### Полный вывод результатов
Для демонстрации результатов с форматированным выводом:

```sql
:r tests/complete-output.sql
```

## Примеры использования

### Пример 1: Получение платежей для клиента за период

```sql
SELECT * 
FROM dbo.GetDailyPayments(1, '2022-01-02', '2022-01-07')
ORDER BY Dt;
```

### Пример 2: Получение только дней с платежами

```sql
SELECT * 
FROM dbo.GetDailyPayments(1, '2022-01-01', '2022-12-31')
WHERE Сумма > 0
ORDER BY Dt;
```

### Пример 3: Подсчет общей суммы за период

```sql
SELECT SUM(Сумма) AS TotalAmount
FROM dbo.GetDailyPayments(1, '2022-01-01', '2022-01-31');
```

## Файлы в проекте

### Основные скрипты
- `create-database.sql` - создание базы данных
- `dbo/tables/ClientPayments.sql` - создание таблицы платежей
- `dbo/tables/ClientPayments_SeedData.sql` - тестовые данные
- `dbo/functions/GetDailyPayments.sql` - табличная функция
- `install-all.sql` - главный скрипт установки

### Тесты и проверки
- `tests/test-GetDailyPayments.sql` - базовые тесты функции
- `tests/examples-GetDailyPayments.sql` - примеры из задания с результатами
- `tests/expected-results.sql` - сравнение с ожидаемыми результатами
- `tests/verify-results.sql` - автоматическая верификация всех требований
- `tests/actual-results.sql` - фактические результаты выполнения функции
- `tests/complete-output.sql` - полный форматированный вывод результатов

## Примечания

1. Функция использует рекурсивное CTE для генерации всех дат в интервале
2. Для интервалов более 10000 дней может потребоваться увеличение MAXRECURSION
3. Функция возвращает 0 для дней без платежей
4. Все даты в интервале включительно (от @Sd до @Ed)

## Требования

- Microsoft SQL Server 2016 или выше
- SQL Server Management Studio или Azure Data Studio

