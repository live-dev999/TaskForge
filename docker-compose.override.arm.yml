version: '3.8'

networks:
  frontend:
  backend:

services:
  postgres.data:
    container_name: postgres.data
    image: ${POSTGRES_IMAGE:-postgres:16-alpine}
    platform: ${PLATFORM:-linux/arm64}
    environment:
      - POSTGRES_DB=TaskForge
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  taskforge.api:
    container_name: taskforge.api
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - ConnectionString=Host=postgres.data;Port=5432;Database=TaskForge;Username=postgres;Password=postgres
      - ConnectionStrings__DefaultConnection=Host=postgres.data;Port=5432;Database=TaskForge;Username=postgres;Password=postgres
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost:3000}
      # OpenTelemetry configuration (supports both formats)
      - OpenTelemetry__ServiceName=${OTEL_SERVICE_NAME:-TaskForge.API}
      - OpenTelemetry__ServiceVersion=${OTEL_SERVICE_VERSION:-1.0.0}
      - OpenTelemetry__EnableConsoleExporter=${OTEL_ENABLE_CONSOLE_EXPORTER:-true}
      - OpenTelemetry__Otlp__Endpoint=${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4317}
      # Standard OTEL environment variables (alternative format)
      - OTEL_SERVICE_NAME=${OTEL_SERVICE_NAME:-TaskForge.API}
      - OTEL_SERVICE_VERSION=${OTEL_SERVICE_VERSION:-1.0.0}
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4317}
      # RabbitMQ configuration
      - RabbitMQ__HostName=rabbitmq
      - RabbitMQ__Port=5672
      - RabbitMQ__UserName=${RABBITMQ_USER:-guest}
      - RabbitMQ__Password=${RABBITMQ_PASSWORD:-guest}
      # EventProcessor configuration (for synchronous event processing)
      - EventProcessor__BaseUrl=${EVENT_PROCESSOR_BASE_URL:-http://taskforge.eventprocessor:80}
      - EVENT_PROCESSOR_BASE_URL=${EVENT_PROCESSOR_BASE_URL:-http://taskforge.eventprocessor:80}
      # DatabaseInitializer configuration
      - DatabaseInitializer__Initialize=${DATABASE_INITIALIZER_INITIALIZE:-true}
      - DatabaseInitializer__Seed=${DATABASE_INITIALIZER_SEED:-true}
      - DatabaseInitializer__DropOnMigrationConflict=${DATABASE_INITIALIZER_DROP_ON_MIGRATION_CONFLICT:-false}
    ports:
      - "5009:80"
    depends_on:
      postgres.data:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      otel-collector:
        condition: service_started
      taskforge.eventprocessor:
        condition: service_started
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:80/health/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  taskforge.eventprocessor:
    container_name: taskforge.eventprocessor
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - ConnectionString=Host=postgres.data;Port=5432;Database=TaskForge;Username=postgres;Password=postgres
      - ConnectionStrings__DefaultConnection=Host=postgres.data;Port=5432;Database=TaskForge;Username=postgres;Password=postgres
      # OpenTelemetry configuration for EventProcessor
      - OpenTelemetry__ServiceName=${OTEL_SERVICE_NAME_EVENTPROCESSOR:-TaskForge.EventProcessor}
      - OpenTelemetry__ServiceVersion=${OTEL_SERVICE_VERSION:-1.0.0}
      - OpenTelemetry__EnableConsoleExporter=${OTEL_ENABLE_CONSOLE_EXPORTER:-true}
      - OpenTelemetry__Otlp__Endpoint=${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4317}
      - OTEL_SERVICE_NAME=${OTEL_SERVICE_NAME_EVENTPROCESSOR:-TaskForge.EventProcessor}
      - OTEL_SERVICE_VERSION=${OTEL_SERVICE_VERSION:-1.0.0}
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4317}
    ports:
      - "5010:80"
    depends_on:
      postgres.data:
        condition: service_healthy
      otel-collector:
        condition: service_started
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:80/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  pgadmin:
    container_name: pgadmin
    image: dpage/pgadmin4:latest
    platform: ${PLATFORM:-linux/arm64}
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_EMAIL:-admin@pgadmin.org}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_PASSWORD:-admin}
      - PGADMIN_CONFIG_SERVER_MODE=False
      - PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED=False
      - PGADMIN_CONFIG_CHECK_EMAIL_DELIVERABILITY=False
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
      - ./docker/pgadmin/servers.json:/pgadmin-init/servers.json:ro
      - ./docker/pgadmin/setup.py:/pgadmin-init/setup.py:ro
    entrypoint: >
      /bin/bash -c "
      python3 /pgadmin-init/setup.py &
      exec /entrypoint.sh
      "
    networks:
      - backend
    depends_on:
      postgres.data:
        condition: service_healthy

volumes:
  postgres_data:
  pgadmin_data:
